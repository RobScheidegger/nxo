@page "/tictactoe/lobby/{LobbyCode}/{PlayerId}"
@inject HttpClient Http
@inject NavigationManager navigation
@using System.Timers

<div class="container">
    @if (Message != null)
    {
        <div class="alert alert-@MessageType">
            @Message
        </div>
    }
    <div class="row">
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header">
                    Tic-Tac-Toe Lobby
                </div>
                <div class="card-body">
                    <div>Code: @Status?.LobbyCode</div>
                    <div>Status: @Status?.Stage</div>
                    @if (Status != null && Status?.HostPlayerId == PlayerId)
                    {
                        <h4>Game Settings</h4>
                        <div class="form-group">
                            <label class="control-label">Maximum Players</label>
                            <input class="form-control" @bind="@Status.MaximumPlayers" type="number" />
                        </div>
                        <h4>Game Configuration</h4>
                        <div class="form-group">
                            <label class="control-label">Dimensions</label>
                            <input class="form-control" @bind="@Status.Dimensions" type="number" />
                        </div>
                        <div class="form-group">
                            <label class="control-label">Board Size</label>
                            <input class="form-control" @bind="@Status.BoardSize" type="number" />
                        </div>
                        <div class="form-group mt-2">
                            <a class="btn btn-primary" @onclick="ClickSaveSettings">Save Settings</a>
                            <a class="btn btn-success" @onclick="ClickStartGame">Start Game</a>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header">
                    Players
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Nickname</th>
                                <th>Type</th>
                                <th>Token</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Status != null)
                            {
                                @foreach (var player in Status.Players.Where(i => i != null))
                                {
                                    <tr>
                                        <td>@player.PlayerId</td>
                                        <td>@player.Nickname</td>
                                        <td>@(player.Bot ? "Bot" : "Human")</td>
                                        <td>@player.Token</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <div>Loading...</div>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string LobbyCode { get; set; }
    [Parameter]
    public string PlayerId { get; set; }
    public TicTacToeGameStatus Status { get; set; }
    public string Message { get; set; }
    public string MessageType { get; set; }
    public char PlayerToken { get; set; }
    private const int TimerInterval = 1000;
    protected override async Task OnInitializedAsync()
    {
        await Refresh(true);
        var timer = new Timer(TimerInterval);
        timer.Elapsed += async (obj, e) => await Refresh(false);
        timer.Start();

        await base.OnInitializedAsync();
    }
    private async Task Refresh(bool FirstLoad)
    {
        try
        {
            var newStatus = await Http.PostFromJsonAsync<string, TicTacToeGameStatus>($"TicTacToe/GetGameStatus?LobbyCode={LobbyCode}", LobbyCode);
            if(!FirstLoad && newStatus.HostPlayerId == PlayerId)
            {
                Status.Players = newStatus.Players;
                Status.Stage = newStatus.Stage;
            }
            else
            {
                Status = newStatus;
            }
            if (Status.Stage != "Lobby")
            {
                navigation.NavigateTo($"tictactoe/{LobbyCode}/{PlayerId}");
            }
            else
            {
                StateHasChanged();
            }
        }
        catch (Exception err)
        {
            Console.WriteLine("ERROR" + err.Message);
        }
    }
    private async Task ClickSaveSettings()
    {
        var result = await Http.PostFromJsonAsync<TicTacToeGameStatus, SaveSettingsResult>("TicTacToe/SaveSettings", Status);
        Message = result.Message;
        MessageType = result.Success ? "success" : "danger";
    }
    private async Task ClickStartGame()
    {
        var result = await Http.PostFromJsonAsync<string, StartGameResult>($"TicTacToe/StartGame?LobbyCode={LobbyCode}", LobbyCode);
        if (result.Success)
        {
            navigation.NavigateTo($"tictactoe/{LobbyCode}/{PlayerId}");
        }
    }
}
